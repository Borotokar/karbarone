
name: Build Unsigned iOS IPA

on: workflow_dispatch

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - run: flutter pub get

      # جدید: اضافه کردن کد disable signing داخل بلوک post_install موجود
      - name: Update Podfile to Disable Signing
        run: |
          sed -i '' '/flutter_additional_ios_build_settings(target)/a\\
            target.build_configurations.each do |config|\\
              config.build_settings['\''CODE_SIGN_IDENTITY'\''] = '\'''\''\\
              config.build_settings['\''CODE_SIGN_STYLE'\''] = '\''Manual'\''\\
              config.build_settings['\''DEVELOPMENT_TEAM'\''] = '\'''\''\\
              config.build_settings['\''PROVISIONING_PROFILE'\''] = '\'''\''\\
              config.build_settings['\''PROVISIONING_PROFILE_SPECIFIER'\''] = '\'''\''\\
            end\\
          ' ios/Podfile

      - run: pod install
        working-directory: ios

      # disable code signing در project.pbxproj (مانند قبل)
      - name: Disable Code Signing
        run: |
          sed -i '' 's/CODE_SIGN_IDENTITY = ".*"/CODE_SIGN_IDENTITY = ""/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/PROVISIONING_PROFILE = ".*"/PROVISIONING_PROFILE = ""/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = ".*"/PROVISIONING_PROFILE_SPECIFIER = ""/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = ".*"/DEVELOPMENT_TEAM = ""/g' ios/Runner.xcodeproj/project.pbxproj

      - run: flutter build ios --release --no-codesign

      # ساخت IPA (مانند قبل، با symlink)
      - run: mkdir Payload
        working-directory: build/ios/iphoneos

      - run: ln -s $PWD/Runner.app $PWD/Payload/Runner.app
        working-directory: build/ios/iphoneos

      - run: zip -r app.ipa Payload
        working-directory: build/ios/iphoneos

      - uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa
          path: build/ios/iphoneos/app.ipa


