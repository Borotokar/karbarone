name: Build Unsigned iOS IPA

on: workflow_dispatch

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - run: flutter pub get

      - run: pod repo update

      # جدید: clean Pods برای جلوگیری از کش قدیمی و ارورهای previews
      - name: Clean Pods
        run: |
          rm -rf ios/Pods
          rm -f ios/Podfile.lock
          rm -rf ios/Runner.xcworkspace

      - name: Ensure iOS Platform 13.0 is Set 
        run: | 
          # استفاده از sed برای جایگزینی خط platform :ios, ... با platform :ios, '13.0' 
          sed -i '' -E "s/platform :ios, ['\"]?([0-9.]+)?['\"]?/platform :ios, '13.0'/g" ios/Podfile 
           
          echo "Podfile head after platform update:" 
          head -n 5 ios/Podfile 

      - name: Update Podfile to Disable Signing 
        run: | 
          cat <<EOF > disable_signing.rb 
            target.build_configurations.each do |config| 
              config.build_settings['CODE_SIGN_IDENTITY'] = '' 
              config.build_settings['CODE_SIGN_STYLE'] = 'Manual' 
              config.build_settings['DEVELOPMENT_TEAM'] = '' 
              config.build_settings['PROVISIONING_PROFILE'] = '' 
              config.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = '' 
              config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Onone'  # جدید: force برای حل ارور previews disabling
            end 
          EOF 
          sed -i '' '/flutter_additional_ios_build_settings(target)/ r disable_signing.rb' ios/Podfile 
          rm disable_signing.rb 

      - run: pod install --repo-update 
        working-directory: ios 

      - name: Disable Code Signing
        run: |
          sed -i '' -E 's/DEVELOPMENT_TEAM = .+;/DEVELOPMENT_TEAM = "";/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_IDENTITY = ".*"/CODE_SIGN_IDENTITY = ""/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/PROVISIONING_PROFILE = ".*"/PROVISIONING_PROFILE = ""/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = ".*"/PROVISIONING_PROFILE_SPECIFIER = ""/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' -E "s/SWIFT_OPTIMIZATION_LEVEL = .+;/SWIFT_OPTIMIZATION_LEVEL = -Onone;/g" ios/Runner.xcodeproj/project.pbxproj  # جدید: force در pbxproj

      - run: flutter build ios --release --no-codesign

      - run: mkdir Payload
        working-directory: build/ios/iphoneos

      - run: mv Runner.app Payload
        working-directory: build/ios/iphoneos

      - run: zip -r app.ipa Payload
        working-directory: build/ios/iphoneos

      - uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa
          path: build/ios/iphoneos/app.ipa
